#[gcode_macro T1]
#gcode:
  #ACTIVATE_EXTRUDER extruder=extruder1
  #SAVE_VARIABLE VARIABLE=currentextruder VALUE='"extruder1"'

#[gcode_macro T0]
#gcode:
  #ACTIVATE_EXTRUDER extruder=extruder
  #SAVE_VARIABLE VARIABLE=currentextruder VALUE='"extruder"'

# -----------------------------------------------------------------------------------------------------------
# Print Macros 
# -----------------------------------------------------------------------------------------------------------
[gcode_macro PRINT_START]
description: Macro to Start a PrintJob (BED_TEMP, EXTRUDER_TEMP to be set)
gcode:

    {% set BED_TEMP = params.BED_TEMP|default(60)|int %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(220)|int %}
# Eddy Correction -------------------------        
    {% set eddy_offset = printer.save_variables.variables.eddy_offset|float %}
    # if the extruder temperature is below the pre-heating temp 150 then set the pre-heating temp to prevent oozing
    # else keep it to not cool down extruder (time waste)
    {% if printer.extruder.temperature < 150 %}   
      M117 Pre-heating ... Extruder: 150
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150
    {% endif %}
    # Heat up Bed and Extruder
    M117 Start heating ... Bed:{BED_TEMP}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={BED_TEMP}
    LED_OFF

    # Home the printer
    {% if printer.toolhead.homed_axes != 'xyz' %}
	G28							            ; Home all  Axes
	{% endif %}
# Eddy Correction -------------------------    
# Set z offset
        SET_GCODE_OFFSET Z={eddy_offset}
        SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Start"' 
        UPDATE_DELAYED_GCODE ID=_print_start_wait DURATION=0.5
# Eddy Correction -------------------------
    # clear and create new mesh at print start
    M117 Create Print Area Bedmesh
    LED_Yellow
# Start fast bedmesh scanwith Eddy Probe -----    
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE PROFILE=default
# End fast bedmesh scanwith Eddy Probe -----    
    M117 Start heating ... Extruder:{EXTRUDER_TEMP}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={EXTRUDER_TEMP}
    G28 X0 Y0                              ; move head out of print area in case of ozzing filament
    LED_Blue
    M190 S{BED_TEMP}                       ; Wait on  Bed Temperature
    LED_Green
    M109 S{EXTRUDER_TEMP}                  ; Wait on  Extruder Temperature
#    LED_Red
#    _PRIME                                 ; print prime blob
#    LED_ON
    LED_Red
    _prime_line                            ; print prime line
    LED_ON
    G21                                    ; set units to millimeter
    
[gcode_macro _prime_line]
gcode:
#    Material E-Step Settings --------------------
#    M92 X80.12 Y80.12 Z399.78 E452.74 ; genau 20mm
#    M92 X80.12 Y80.12 Z399.78 E433.00 ; PLA 3DPrima
#    M92 X80.12 Y80.12 Z399.78 E452.74 ; PLA 3DPrima - Dark Grey
#    M92 X80.12 Y80.12 Z399.78 E448.59 ; PETG 3DPrima-Yellow
#    M92 X80.12 Y80.12 Z399.78 E521.96 ; PETG M4P-Orange
#    M92 X80.12 Y80.12 Z399.78 E529.26 ; PETG M4P-Gray
#    M92 X80.12 Y80.12 Z399.78 E529.26 ; PETG M4P-Red

    M117 Purge extruder and start Cleanup Lines
    G92 E0                                   ; reset extruder
#  print prime blob
#    PRIME_BLOB
    
#    draw the cleanup lines on Y ----------------------
    G90                                      ; absolut Poisitioning
    G1 Z1.0 F3000                            ; move z up little to prevent scratching of surface
    G1 X20 Y40 Z2 F5000.0                    ; move to start-line position
    G1 F60 Z0                                ; set z-position to 0
    G1 X20 Y200 Z0.3 F1500.0 E30             ; draw 1st line
    G1 X22 Y200 Z0.3 F5000.0                 ; move to side a little
    G1 X22 Y20 Z0.3 F1500.0 E55              ; draw 2nd line

#    G92 E0 ; reset extruder
#   alternate cleanup line 90 degree on X ---------------------
#    G1 Z2.0 F3000 ; move z up little to prevent scratching of surface
#    G1 X20 Y20 Z0.3 F5000.0  ; move to side a little
#    G1 X200.0 Y20 Z0.3 F1500.0 E25 ; draw 2nd line
#    G1 X200.0 Y22.0 Z0.3 F5000.0 ; move to side a little
#    G1 X22 Y22 Z0.3 F1500.0 E50 ; draw 2nd line

    G92 E0 ; reset extruder
    G1 Z1.0 F3000 ; move z up little to prevent scratching of surface
    M117 Start printing ...

[gcode_macro PRINT_END]
description: Macro to End  a PrintJob and present the print (MACHINE_DEPTH to be set)
gcode:
    {% set MACHINE_DEPTH = params.MACHINE_DEPTH|default(300)|int %}
    M117 End printing ...turn all heaters off
    TURN_OFF_HEATERS              ; Turn off bed, extruder, and fan
    M117 End printing .... move print head away
    G91                           ; relative Positionning
    G1 E-1 F300                   ; Retract 
    G1 Z50 F3000                  ;  Raise nozzle by 50mm
    M117 End printing ... present result
    G90                           ;  Absolute positionning
    G1 Y{MACHINE_DEPTH}           ;  Present print
    M117 End printing ... turn motors off
    M84                           ; Disable steppers
    LED_OFF
    M117 Print done
# Eddy Correction -------------------------        
    SET_GCODE_OFFSET Z=0        # Reset z offest
# Eddy Correction -------------------------        

[gcode_macro PRIME_BLOB]
description: Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
variable_macro_travel_speed: 150
variable_macro_z_speed: 15
variable_nozzle_prime_bridge_fan: 102
variable_nozzle_prime_start_x: 10 # min, max or number
variable_nozzle_prime_start_y: 10 # min, max or number
variable_nozzle_prime_direction: "auto" # auto, forwards, backwards
variable_nozzle_prime_bridge_fan: 102
variable_start_print_park_z_height: 50
variable_EXTRUDER_TEMP: 220

gcode:
    M117 Start heating ... Extruder:{EXTRUDER_TEMP}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=220
    G28 X0 Y0
	
    SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = macro_travel_speed|float * 60 %}
	{% set z_speed = macro_z_speed|float * 60 %}
	{% set fan_speed = nozzle_prime_bridge_fan|float %}
	{% if nozzle_prime_start_x|lower == 'min' %}
		{% set x_start = 5 %}
	{% elif nozzle_prime_start_x|lower == 'max' %}
		{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
		{% set x_start = nozzle_prime_start_x|float %}
	{% endif %}
	{% if nozzle_prime_start_y|lower == 'min' %}
		{% set y_start = 5 %}
		{% set y_factor = 1 %}
	{% elif nozzle_prime_start_y|lower == 'max' %}
		{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
		{% set y_factor = -1 %}
	{% else %}
		{% set y_start = nozzle_prime_start_y|float %}
		{% if nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
			{% set y_factor = 1 %}
		{% else %}
			{% set y_factor = -1 %}
		{% endif %}
	{% endif %}
	{% if nozzle_prime_direction|lower == 'forwards' %}
		{% set y_factor = 1 %}
	{% elif nozzle_prime_direction|lower == 'backwards' %}
		{% set y_factor = -1 %}
	{% endif %}
	{% set z = start_print_park_z_height|float %}
	# Absolute positioning
	G90 
	# Relative extrusion
	M83
	# Lift to start print Z height
	G0 Z{z} F{z_speed}
	# move close to blob position along the edge of the bed
	G1 X{x_start} F{speed}
	G1 Y{y_start + (15 * y_factor)} F{speed}
	# Lower to blob extrusion height
	G1 Z0.5 F{z_speed}
	# Move to final position horizontally
	G1 Y{y_start} F{speed}
	# Extrude a blob
	G1 F60 E20
	# 40% fan
	M106 S{fan_speed} 
	# Move the extruder up by 5mm while extruding, breaks away from blob
	G1 Z5 F100 E5  
	# Move to wipe position, but keep extruding so the wipe is attached to blob
	G1 F200 Y{y_start + (25 * y_factor)} E1 
	# Go down diagonally while extruding
	# Broken down in z moves under 2mm as a workaround for a tuning tower test.
	# The tuning tower command thinks a new print has been started when z moves over 2mm and aborts.
	G1 F200 Y{y_start + (30 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (35 * y_factor)} Z2.6 E0.5
	G1 F200 Y{y_start + (40 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (45 * y_factor)} Z0.2 E0.5
	# 0% fan
	M106 S0
	# small wipe line
	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6 
	# Break away wipe
	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state


[pause_resume]
recover_velocity: 50.

[gcode_macro PAUSE]
description: Pause the actual running print
rename_existing: PAUSE_BASE
gcode:
    ##### set defaults #####
    {% set x = params.X|default(230) %}      #edit to your park position
    {% set y = params.Y|default(230) %}      #edit to your park position
    {% set z = params.Z|default(10)|float %} #edit to your park position
    {% set e = params.E|default(1) %}        #edit to your retract length
    ##### calculate save lift position #####
    {% set max_z = printer.toolhead.axis_maximum.z|float %}
    {% set act_z = printer.toolhead.position.z|float %}
    {% set lift_z = z|abs %}
    {% if act_z < (max_z - lift_z) %}
        {% set z_safe = lift_z %}
    {% else %}
        {% set z_safe = max_z - act_z %}
    {% endif %}
    ##### end of definitions #####
    PAUSE_BASE
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E-{e} F2100
    {% else %}
      {action_respond_info("Extruder not hot enough")}
    {% endif %}
    {% if "xyz" in printer.toolhead.homed_axes %}    
      G1 Z{z_safe}
      G90
      G1 X{x} Y{y} F6000
    {% else %}
      {action_respond_info("Printer not homed")}
    {% endif %}
# Eddy Correction -------------------------        
    SET_GCODE_OFFSET Z=0        # Reset z offest
# Eddy Correction -------------------------        
    
    
[gcode_macro RESUME]
description: Resume the actual running print
rename_existing: RESUME_BASE
gcode:
# Eddy Correction -------------------------        
    {% set eddy_offset = printer.save_variables.variables.eddy_offset|float %}
    SET_GCODE_OFFSET Z={eddy_offset}          # Read stored offest
# Eddy Correction -------------------------        
    
    ##### set defaults #####
    {% set e = params.E|default(1) %} #edit to your retract length
    #### get VELOCITY parameter if specified ####
    {% if 'VELOCITY' in params|upper %}
      {% set get_params = ('VELOCITY=' + params.VELOCITY)  %}
    {%else %}
      {% set get_params = "" %}
    {% endif %}
    ##### end of definitions #####
    G91
    {% if printer.extruder.can_extrude|lower == 'true' %}
      G1 E{e} F2100
    {% else %}
      {action_respond_info("Extruder not hot enough")}
    {% endif %}  
    RESUME_BASE {get_params}

#[gcode_macro CANCEL_PRINT]
#description: Cancel the actual running print
#rename_existing: CANCEL_PRINT_BASE
#gcode:
#    LED_OFF
#    TURN_OFF_HEATERS
#    CANCEL_PRINT_BASE


[gcode_macro CANCEL_PRINT]
description: Cancel the actual running print
rename_existing: CANCEL_PRINT_BASE
gcode:
  ##### get user parameters or use default #####
  {% set client = printer['gcode_macro _CLIENT_VARIABLE']|default({}) %}
  {% set allow_park = client.park_at_cancel|default(false)|lower == 'true' %}
  {% set retract = client.cancel_retract|default(5.0)|abs %}
  ##### define park position #####
  {% set park_x = "" if (client.park_at_cancel_x|default(none) is none)
            else "X=" ~ client.park_at_cancel_x %}
  {% set park_y = "" if (client.park_at_cancel_y|default(none) is none)
            else "Y=" ~ client.park_at_cancel_y %}
  {% set custom_park = park_x|length > 0 or park_y|length > 0 %}
  ##### end of definitions #####
  # restore idle_timeout time if needed
  {% if printer['gcode_macro RESUME'].restore_idle_timeout > 0 %}
    SET_IDLE_TIMEOUT TIMEOUT={printer['gcode_macro RESUME'].restore_idle_timeout}
  {% endif %}
  {% if (custom_park or not printer.pause_resume.is_paused) and allow_park %} _TOOLHEAD_PARK_PAUSE_CANCEL {park_x} {park_y} {% endif %}
  _CLIENT_RETRACT LENGTH={retract}
  TURN_OFF_HEATERS
  M106 S0
  {client.user_cancel_macro|default("")}
  SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=idle_state VALUE=False
  # clear pause_next_layer and pause_at_layer as preparation for next print
  SET_PAUSE_NEXT_LAYER ENABLE=0
  SET_PAUSE_AT_LAYER ENABLE=0 LAYER=0
  G91
  G1 Z50.0 F1000
# Eddy Correction -------------------------        
    SET_GCODE_OFFSET Z=0        # Reset z offest
# Eddy Correction -------------------------        
  CANCEL_PRINT_BASE