[gcode_macro TEST]
gcode:
  M117 "Homed Axes:" {printer.toolhead.homed_axes}

[gcode_macro TEST_VARS]
description: "Filament laden mit Materialwahl oder manueller Temperatur"
variable_material: "PLA"
variable_material_temp: 200
gcode:
    {% if params.MATERIAL %}
      {% if params.MATERIAL|upper == "PLA" %}
        M117 Lade PLA bei 200°C
      {% elif params.MATERIAL|upper == "PETG" %}
          M117 Lade PETG bei 240°C
      {% else %}
          M117 Unbekanntes Material: {params.MATERIAL}
      {% endif %}
    {% elif params.TEMP %}
      {% if params.TEMP|int > 0 %}
          M117 Lade manuell bei {params.TEMP}°C
      {% endif %}    
    {% endif %}  

[gcode_macro DUMP_VARIABLES]
gcode:
    {% set filter_name = params.NAME|default('')|string|lower %}
    {% set filter_value = params.VALUE|default('')|string|lower %}
    {% set show_cfg = params.SHOW_CFG|default(0)|int %}
    {% set out = [] %}
    {% for key1 in printer %}
        {% for key2 in printer[key1] %}
            {% if (show_cfg or not (key1|lower == 'configfile' and key2|lower in ['config', 'settings'])) and (filter_name in key1|lower or filter_name in key2|lower) and filter_value in printer[key1][key2]|string|lower %}
                {% set dummy = out.append("printer['%s'].%s = %s" % (key1, key2, printer[key1][key2])) %}
            {% endif %}
        {% else %}
            {% if filter_name in key1|lower and filter_value in printer[key1]|string|lower %}
                {% set dummy = out.append("printer['%s'] = %s" % (key1, printer[key1])) %}
            {% endif %}
        {% endfor %}
    {% endfor %}
    {action_respond_info(out|join("\n"))}


[gcode_macro DUMP_FILAMENT_SENSOR]
description: Debug – dump all filament sensor attributes
gcode:
    {% set fs = printer["filament_switch_sensor filament_sensor"] %}

    {action_respond_info("=== FILAMENT SENSOR DUMP ===")}

    {action_respond_info("enabled: " ~ fs.enabled)}
    {action_respond_info("filament_detected: " ~ fs.filament_detected)}

    {% if fs.runout_distance is defined %}
        {action_respond_info("runout_distance: " ~ fs.runout_distance)}
    {% endif %}

    {% if fs.pause_on_runout is defined %}
        {action_respond_info("pause_on_runout: " ~ fs.pause_on_runout)}
    {% endif %}

    {% if fs.event_delay is defined %}
        {action_respond_info("event_delay: " ~ fs.event_delay)}
    {% endif %}

    {% if fs.switch_pin is defined %}
        {action_respond_info("switch_pin: " ~ fs.switch_pin)}
    {% endif %}

    {% if fs.insert_gcode is defined %}
        {action_respond_info("insert_gcode: defined")}
    {% endif %}

    {% if fs.runout_gcode is defined %}
        {action_respond_info("runout_gcode: defined")}
    {% endif %}

    {% if fs.printer_state is defined %}
        {action_respond_info("printer_state: " ~ fs.printer_state)}
    {% endif %}

    {action_respond_info("=== END FILAMENT SENSOR DUMP ===")}


# Copyright (C) 2022 Justin Schuh <code@justinschuh.com>
#
# This file may be distributed under the terms of the GNU GPLv3 license.

[gcode_macro _km_save_state]
description: Tracks gcode state.
variable_state_set: {}
variable_is_ephemeral: 0
gcode:
  {% if params.SAVE|int %}
    {% set dummy = state_set.__setitem__(params.NAME, None) %}
  {% else %}
    {% set dummy = state_set.__delitem__(params.NAME) %}
  {% endif %}
  SET_GCODE_VARIABLE MACRO=_km_save_state VARIABLE=is_ephemeral VALUE="{ 1 if state_set|length > 0 else 0 }"

[gcode_macro save_gcode_state]
description: Wraps SAVE_GCODE_STATE to track persistence state.
  Usage: See Klipper documentation
rename_existing: _KM_SAVE_GCODE_STATE
gcode:
  _KM_SAVE_GCODE_STATE {rawparams}
  {% set NAME = params.NAME|default("default") %}
  _km_save_state NAME={NAME} SAVE=1

[gcode_macro restore_gcode_state]
description: Wraps RESTORE_GCODE_STATE to track persistence state.
  Usage: See Klipper documentation
rename_existing: _KM_RESTORE_GCODE_STATE
gcode:
  _KM_RESTORE_GCODE_STATE {rawparams}
  {% set NAME = params.NAME|default("default") %}
  _km_save_state NAME={NAME} SAVE=0

[gcode_macro _abort_on_gcode_state]
gcode:
  {% set save_state = printer["gcode_macro _km_save_state"] %}
  {% if save_state.is_ephemeral %}
    {action_raise_error("Encountered unexpected save state " +
                          save_state.state_set|list|sort|string)}
  {% endif %}