# -----------------------------------------------------------------------------------------------------------
# Macros reused from Sovol Zero
# -----------------------------------------------------------------------------------------------------------
# global vars macro
# -----------------------------------------------------------------------------------------------------------
[gcode_macro _global_var]
description: Macro to define global default variables)
variable_pause_park:{'x': 270, 'y': 270, 'z': 3, 'e': 1}
variable_cancel_park:{'x': 270, 'y': 270, 'z': 3, 'e': 1}
variable_z_maximum_printer: 5
#variable_pause_park:{'x': 270, 'y': 270, 'z': 50, 'e': 1}
#variable_cancel_park:{'x': 270, 'y': 270, 'z': 100, 'e': 1}
#variable_z_maximum_printer: 290

variable_pause_resume_travel_speed: 150
variable_load_filament_extruder_temp: 250
variable_extruder_min_temp: 220
variable_nozzle_preheat_temp: 230

#variable_stop_action: False
variable_debug: True
gcode:

# -----------------------------------------------------------------------------------------------------------
# Main Macro Area
# -----------------------------------------------------------------------------------------------------------
[gcode_macro ALL_FAN_OFF]
description: Turns all fans off
gcode:
    #SET_FAN_SPEED FAN=fan0 SPEED=0
    #SET_FAN_SPEED FAN=fan2 SPEED=0

[gcode_macro CLEAR_PAUSE]
rename_existing: CLEAR_PAUSE_BASE
description: Clear pause state safely
gcode:
    {% if printer.pause_resume.is_paused %}
        # nur den Pause-Status auflösen, ohne Moves/Extrusion
        CLEAR_PAUSE_BASE
    {% else %}
        # nichts zu tun
    {% endif %}

[gcode_macro PRINT_START]      
gcode:
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=True

[gcode_macro PRINT_END]
gcode:
    SAVE_VARIABLE VARIABLE=was_interrupted VALUE=False
    #- sovol specific - RUN_SHELL_COMMAND CMD=clear_plr
    clear_last_file

[gcode_macro START_PRINT]
description: Macro to Start a PrintJob (BED_TEMP, EXTRUDER_TEMP to be set)
# Reference https://github.com/KevinOConnor/klipper/blob/master/docs/Config_Reference.md;gcode_macroA
#default_parameter_BED_TEMP : 60
#default_parameter_EXTRUDER_TEMP : 220
variable_parameter_AREA_START : 0,0
variable_parameter_AREA_END : 0,0
variable_parameter_PRINT_MIN : 0,0
variable_parameter_PRINT_MAX : 0,0

gcode:
    {% if printer.save_variables.variables.was_interrupted|default(0)|int == 1 %}
        PRINT_END                                                     ; Clear the last printed power-off information
        #- sovol specific - CHANG_ROOT_MAIN                           ; macro doesnt exist
        SET_DISPLAY_TEXT
    {% endif %}
    CLEAR_PAUSE

    # set Extruder and Bed Temp
    {% set BED_TEMP = params.BED_TEMP|default(60)|int %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(220)|int %}
    {% if printer.extruder.temperature < 150 %}   
      M117 Pre-heating ... Extruder: 150
      SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150               ; sets Extruder temp and continues next command
    {% endif %}
    
    # Heat up Bed and Extruder
    M117 Start heating ... Bed:{BED_TEMP}
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET={BED_TEMP}        ; sets Bed temp and continues next command
    
    LED_OFF
    # Home the printer
    {% if printer.toolhead.homed_axes|upper != 'XYZ' %}
  	  G28					                                          ; Home all  Axes
	{% endif %}
	
    # clear and create new mesh at print start
    M117 Create Print Area Bedmesh
    LED_Yellow
    BED_MESH_CLEAR
    BED_MESH_PROFILE LOAD=default
    {% if (params.AREA_START != null) and (params.AREA_END  != null) %}
      BED_MESH_CALIBRATE PRINT_MIN={params.AREA_START} PRINT_MAX={params.AREA_END}
      {% set did_calibrate = True %}
    {% else %}
      {% if (params.PRINT_MIN != null) and (params.PRINT_MAX  != null) %}
        {% if (params.FORCE_NEW_MESH != null)  %}
          BED_MESH_CALIBRATE PRINT_MIN={params.PRINT_MIN} PRINT_MAX={params.PRINT_MAX} FORCE_NEW_MESH=True
        {% else %}
          BED_MESH_CALIBRATE PRINT_MIN={params.PRINT_MIN} PRINT_MAX={params.PRINT_MAX}
        {% endif %}
        {% set did_calibrate = True %}
      {% endif %}
    {% endif %}
    {% if did_calibrate %}
      BED_MESH_PROFILE SAVE=area
      # LOAD ist optional – nur als Sicherheitsgurt
      # BED_MESH_PROFILE LOAD=area
    {% endif %}
    
    M117 Start heating ... Extruder:{EXTRUDER_TEMP}
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={EXTRUDER_TEMP} ; set target extruder temp and continue
    G28 X0 Y0                                                     ; move head out of print area in case of ozzing filament
    LED_Blue
    M190 S{BED_TEMP}                                              ; Wait on  Bed Temperature
    LED_Green
    M109 S{EXTRUDER_TEMP}                                         ; Wait on  Extruder Temperature
    LED_Red
    PRIME_BLOB EXTRUDER_TEMP={EXTRUDER_TEMP}                      ; print prime blob
    PRIME_LINE EXTRUDER_TEMP={EXTRUDER_TEMP}  BLOB=true           ; print prime line
    LED_ON
    G21                                                           ; set units to millimeter
    M117 Start printing ...

[gcode_macro END_PRINT]
description: Macro to End  a PrintJob and present the print (MACHINE_DEPTH to be set)
gcode:
    {% set MACHINE_DEPTH = params.MACHINE_DEPTH|default(300)|int %}
    M117 End printing ...turn all heaters off
    TURN_OFF_HEATERS                                              ; Turn off bed, extruder, and fan
    M117 End printing .... move print head away
    G91                                                           ; relative Positionning
    G1 E-2 F300                                                   ; Retract 2mm

    MOVE_SAVE_Z_POSITION                                                ; move to a save position
    #{% set stop = printer["gcode_macro _global_var"].stop_action %}     ; get stop action status
    {% set stop = printer.save_variables.variables.stop_action|default(False) %}
    
    {% if not stop %}                                             ; if we have a save z-position we can move out of the model
      #G1 Z100 F3000                                                 ;  Raise nozzle by 100mm
      M117 End printing ... present result
      G90                                                           ;  Absolute positionning
      G1 Y{MACHINE_DEPTH}                                           ;  Present print
    {% endif %}
    
    M117 End printing ... turn motors off
    M84                                                           ; Disable steppers

    CLEAR_PAUSE
    PRINT_END
    
    LED_OFF
    M117 Print done.
    
[gcode_macro PRIME_LINE]
description: Prints a primeline
variable_nozzle_prime_start_x: 5             ; prime line start x position
variable_nozzle_prime_start_y: 40            ; prime line start y position
variable_nozzle_prime_end_y: 200             ; prime line end y position
variable_nozzle_prime_step_x: 2              ; x-shift for the second primeline

gcode:
    {% set prime_blob = params.BLOB|default("false")|lower %}   ; set prime blob variable from params

    # Home the printer
    M117 Homed-Axes: {printer.toolhead.homed_axes}
    {% if printer.toolhead.homed_axes|upper != 'XYZ' %}
	  G28							            ; Home all  Axes
	{% endif %}
    #G28 X Y                                     ; go to oozing position

    # Set Extruder Temp
    {% set MIN_TEMP= printer["gcode_macro _global_var"].extruder_min_temp|int %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(MIN_TEMP)|int %}
    {% if printer.extruder.temperature < EXTRUDER_TEMP %}
      M117 Start heating ... Extruder:{EXTRUDER_TEMP}
      M109 S{EXTRUDER_TEMP}
    {% endif %}

    {% set prime_step_x = nozzle_prime_start_x|float + nozzle_prime_step_x|float %}
    
    SAVE_GCODE_STATE NAME=prime_line_state
    M117 Purge extruder and start Cleanup Lines
    G90                                                                           ; absolut Poisitioning
    M82                                                                           ; absolut Extrusion 
    #M83                                                                           ; relative Extrusion (empfohlen)
    G92 E0                                                                        ; reset extruder
# draw the cleanup lines on Y ----------------------
    {% if prime_blob != "true" %}
      G1 Z5.0 F3000                                                                 ; move z up little to prevent scratching of surface
      G1 X{nozzle_prime_start_x} Y{nozzle_prime_start_y} Z2 F5000.0                 ; move to start-line position
    {% endif %}  
    G1 F60 Z0                                                                     ; set z-position to 0
    G1 X{nozzle_prime_start_x} Y{nozzle_prime_end_y} Z0.4 F1500.0 E30             ; draw 1st line
    G1 X{prime_step_x} Y{nozzle_prime_end_y} Z0.4 F5000.0                         ; move to side a little
    G1 X{prime_step_x} Y{nozzle_prime_start_y} Z0.4 F1500.0 E60                   ; draw 2nd line

    G92 E0                                                                        ; reset extruder
    G1 Z1.0 F3000                                                                 ; move z up little to prevent scratching of surface
    RESTORE_GCODE_STATE NAME=prime_line_state
    
[gcode_macro PRIME_BLOB]
description: Prints a primeblob, used internally, if configured, as part of the START_PRINT macro. Slower than PRIME_LINE but much more effective.
variable_macro_travel_speed: 150
variable_macro_z_speed: 15
variable_nozzle_prime_start_x: 5                                                  ; min, max or number
variable_nozzle_prime_start_y: 5                                                  ; min, max or number
variable_nozzle_prime_direction: "auto"                                           ; auto, forwards, backwards
variable_nozzle_prime_bridge_fan: 102
variable_start_print_park_z_height: 50

gcode:

    # Home the printer
    M117 [Debug] Homed-Axes: {printer.toolhead.homed_axes}
    {% if printer.toolhead.homed_axes|upper != 'XYZ' %}
	  G28							            ; Home all  Axes
	{% endif %}
    #G28 X Y                                     ; go to oozing position

    # Set Extruder Temp
    {% set MIN_TEMP= printer["gcode_macro _global_var"].extruder_min_temp|int %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(MIN_TEMP)|int %}
    {% if printer.extruder.temperature < EXTRUDER_TEMP %}
      M117 Start heating ... Extruder:{EXTRUDER_TEMP}
      M109 S{EXTRUDER_TEMP}
    {% endif %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(MIN_TEMP)|int %}

    SAVE_GCODE_STATE NAME=prime_blob_state
	M117 Priming nozzle with prime blob..
	#RESPOND MSG="Priming nozzle with prime blob.."
	{% set speed = macro_travel_speed|float * 60 %}
	{% set z_speed = macro_z_speed|float * 60 %}
	{% set fan_speed = nozzle_prime_bridge_fan|float %}
	{% if nozzle_prime_start_x|lower == 'min' %}
		{% set x_start = 5 %}
	{% elif nozzle_prime_start_x|lower == 'max' %}
		{% set x_start = printer.toolhead.axis_maximum.x - 5 %}
	{% else %}
		{% set x_start = nozzle_prime_start_x|float %}
	{% endif %}
	{% if nozzle_prime_start_y|lower == 'min' %}
		{% set y_start = 5 %}
		{% set y_factor = 1 %}
	{% elif nozzle_prime_start_y|lower == 'max' %}
		{% set y_start = printer.toolhead.axis_maximum.y - 5 %}
		{% set y_factor = -1 %}
	{% else %}
		{% set y_start = nozzle_prime_start_y|float %}
		{% if nozzle_prime_start_y|float < printer.toolhead.axis_maximum.y / 2 %}
			{% set y_factor = 1 %}
		{% else %}
			{% set y_factor = -1 %}
		{% endif %}
	{% endif %}
	{% if nozzle_prime_direction|lower == 'forwards' %}
		{% set y_factor = 1 %}
	{% elif nozzle_prime_direction|lower == 'backwards' %}
		{% set y_factor = -1 %}
	{% endif %}
	{% set z = start_print_park_z_height|float %}
	
	G90                                                         ; absolute Positionierung
	M83                                                         ; relative Extrusion (empfohlen)
	# Lift to start print Z height
#	G0 Z{z} F{z_speed}
	# move close to blob position along the edge of the bed
#	G1 X{x_start} Y{y_start + (15 * y_factor)} F{speed}
	# Move to final position horizontally
	G1 X{x_start} Y{y_start} F{speed}
    # Lower to blob extrusion height
	G1 Z0.5 F{z_speed}
	# Extrude a blob
	G1 F60 E20
	# 40% fan
	M106 S{fan_speed} 
	# Move the extruder up by 5mm while extruding, breaks away from blob
	G1 Z5 F100 E5  
	# Move to wipe position, but keep extruding so the wipe is attached to blob
#	G1 F200 Y{y_start + (25 * y_factor)} E1 
	# Go down diagonally while extruding
	# Broken down in z moves under 2mm as a workaround for a tuning tower test.
	# The tuning tower command thinks a new print has been started when z moves over 2mm and aborts.
#	G1 F200 Y{y_start + (20 * y_factor)} Z3.8 E0.5
#	G1 F200 Y{y_start + (25 * y_factor)} Z2.6 E0.5
#   G1 F200 Y{y_start + (30 * y_factor)} Z1.4 E0.5
#	G1 F200 Y{y_start + (35 * y_factor)} Z0.2 E0.5
	G1 F200 Y{y_start + (10 * y_factor)} Z3.8 E0.5
	G1 F200 Y{y_start + (15 * y_factor)} Z2.6 E0.5
    G1 F200 Y{y_start + (20 * y_factor)} Z1.4 E0.5
	G1 F200 Y{y_start + (25 * y_factor)} Z0.2 E0.5
    # 0% fan
	M106 S0
	# small wipe line
#	G1 F200 Y{y_start + (50 * y_factor)} Z0.2 E0.6 
	# Break away wipe
#	G1 F{speed} Y{y_start + (100 * y_factor)}
	RESTORE_GCODE_STATE NAME=prime_blob_state


[pause_resume]
recover_velocity: 50.

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
variable_state: 'normal'
variable_execute: True
gcode:

    M117 IsPaused: {printer.pause_resume.is_paused}
    {% if printer.pause_resume.is_paused == False %}
      {% set x_park = printer['gcode_macro _global_var'].pause_park.x|float %}
      {% set y_park = printer['gcode_macro _global_var'].pause_park.y|float %}
      {% set z_park = printer['gcode_macro _global_var'].pause_park.z|float %}
      #{% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
      {% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_printer %}
      {% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}


      {% set _state = params.STATE|default('normal') %}
      {% set state = 'filament_change' if 'filament_change' in _state else 'normal' %}
    
      #{action_respond_info("Pause Print!")}
      #M117 Homed Axes : {homed_axes}
      {% if (printer.toolhead.homed_axes|default("")|upper) == "XYZ" %}
        PAUSE_BASE

        MOVE_SAVE_Z_POSITION
        #{% set stop = printer["gcode_macro _global_var"].stop_action %}
        {% set stop = printer.save_variables.variables.stop_action|default(False) %}
        #M117 [Debug] Stop Action Return: {stop}
        M117 [Debug] Stop Action Variable Return : {stop}

        #{% if not printer.save_variables.variables.stop_action|default(False)|int == 1 %}
        {% if not stop %}                                                     ; if we have a save z-position we can move out of the model
          G90
          {% if printer.gcode_move.position.x != x_park and printer.gcode_move.position.y != y_park  %}
            G1 X{x_park} Y{y_park} F{printer["gcode_macro _global_var"].pause_resume_travel_speed * 60}
          {% endif %}

          M104 S{printer.extruder.target}
    
          {% if state == 'normal' %}
            {% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
              {% if printer['filament_switch_sensor filament_sensor'].enabled == True and printer['filament_switch_sensor filament_sensor'].filament_detected == True %}
                G91
                G1 E-{e_restract} F300
                G90
              {% endif %}
            {% endif %}
          {% elif state == 'filament_change' %}
            {% if (printer.extruder.temperature + 5 >= printer.extruder.target) and (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
              G91
#              G1 E-10 F1500
#              G1 E-20 F600
#              M400
#              G4 P3000
#              G1 E-50 F300 
              G90
            {% endif %}
          {% endif %}
        {% endif %}
      {% else %}
        M117 [Error] Printer not homed .?.
      {% endif %}
    {% endif %}


[delayed_gcode _resume_wait]
gcode:
    {% if printer['gcode_macro RESUME'].execute|lower != 'false' %}
        RESUME
    {% endif %}

[gcode_macro RESUME]
description: Pause the actual running print
rename_existing: RESUME_BASE
variable_state: 'normal'
gcode:
    {% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
    {% set extruder_target_temp = printer.extruder.target|int %}

    {% set _state = params.STATE|default('normal') %}
    {% set state = 'filament_change' if 'filament_change' in _state else 'normal' %}

    {% if (printer.toolhead.homed_axes|default("")|upper) != "XYZ" %}
      M117 [Error] Printer not homed .?.
    {% endif %}

    {% if state == 'filament_change' %}
        {% if printer["filament_switch_sensor filament_sensor"].enabled == True and
              printer["filament_switch_sensor filament_sensor"].filament_detected != True
        %}
            #{action_respond_info("Please Insert filament in Sensor!")}
            M117 Please Insert filament in Sensor
        {% else %}
          {% if (printer.toolhead.homed_axes|default("")|upper) == "XYZ" %}
            {% if printer.extruder.temperature + 5 >= printer.extruder.target %}
                G91
                G1 E30 F300
                G1 E10 F150
                G90
            {% else %}
                M104 S{extruder_target_temp}
                #{action_respond_info("Nozzle not hot enough!")}
                #{action_respond_info("Nozzle heating...")}
                M117 Nozzle not hot enough - heating up nozzle ...
                M109 S{extruder_target_temp}
                G91
                G1 E30 F300
                G1 E10 F150
                G90
            {% endif %}
            #{action_respond_info("Print resumming ...")}
            M117 Print resuming ...
            RESUME_BASE
          {% endif %}
        {% endif %}
    {% elif state == 'normal' %}
        {% if printer['filament_switch_sensor filament_sensor'].enabled != True and
              printer['filament_switch_sensor filament_sensor'].filament_detected != True
        %}
            {action_respond_info("Please Insert filament in Sensor!")}
        {% else %}
          {% if (printer.toolhead.homed_axes|default("")|upper) == "XYZ" %}
            #{action_respond_info("Print resumming!")}
            G91
            G1 E{e_restract} F300
            G90
            M117 Print resuming ...
            RESUME_BASE
          {% endif %}
        {% endif %}
    {% endif %}
   
[gcode_macro CANCEL_PRINT]
description: 
rename_existing: CANCEL_PRINT_BASE
gcode:
    {% set x_park = printer['gcode_macro _global_var'].cancel_park.x|float %}
    {% set y_park = printer['gcode_macro _global_var'].cancel_park.y|float %}
    {% set z_park = printer['gcode_macro _global_var'].cancel_park.z|float %}
    #{% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
    {% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_printer %}
    {% set e_restract = printer['gcode_macro _global_var'].cancel_park.e|float %}
    {% set e_mintemp  = printer.configfile.settings['extruder'].min_extrude_temp %}

    M117 Start cancel Printing  ...
    CANCEL_PRINT_BASE

    G91
#    {% if printer['filament_switch_sensor filament_sensor'].enabled == True and printer['filament_switch_sensor filament_sensor'].filament_detected == True %}
#        {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target and printer.extruder.temperature >= e_mintemp)  %}
#            G1 E-{e_restract} F500
#        {% else %}
#            ;{action_respond_info("Nozzle not hot enough")}
#            M117 Nozzle not hot enough.
#        {% endif %}
#    {% endif %}

    MOVE_SAVE_Z_POSITION
    {% set stop = printer.save_variables.variables.stop_action|default(False) %}
    #M117 [Debug] Stop Action Variable: {printer.save_variables.variables.stop_action}
    M117 [Debug] Stop Action Variable Return : {stop}

    #{% if not printer.save_variables.variables.stop_action|default(0)|int == 1 %}
    #{% set stop = printer["gcode_macro _global_var"].stop_action %}
    #M117 [Debug] Stop Action Return: {stop}
      
    TURN_OFF_HEATERS
    ALL_FAN_OFF
    CLEAR_PAUSE
    PRINT_END
    M84
    #{action_respond_info("Cancel Print Success!")}
    M117 Cancel Print Success!

[gcode_macro M109]
rename_existing: M99109
gcode:    
    {% set s = params.S|default(0)|float %}
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}  
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-2} MAXIMUM={s+2}   
    {% endif %}

[gcode_macro M190]

rename_existing: M99190
gcode:    
    {% set s = params.S|default(0)|float %}    
    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}   
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-2} MAXIMUM={s+2}  
    {% endif %}

[gcode_macro M600]
gcode:
    PAUSE STATE=filament_change

[gcode_macro CONTINUE_PRINT_D]
variable_end_d: 0 
gcode:
    {% set d_start = printer.print_stats.filament_used|float %}
    {% set d_end = (d_start + params.D|float)|float %} 
        SET_GCODE_VARIABLE MACRO=CONTINUE_PRINT_D VARIABLE=end_d VALUE={d_end} 
        UPDATE_DELAYED_GCODE ID=VERIFY_PRINT_D DURATION=1 

[delayed_gcode VERIFY_PRINT_D]
initial_duration: 0 
gcode:
    {% set d_current = printer.print_stats.filament_used|float %} 
    {% if d_current < printer["gcode_macro CONTINUE_PRINT_D"].end_d %} 
        UPDATE_DELAYED_GCODE ID=VERIFY_PRINT_D DURATION=1 
    {% else %}
        M600
        UPDATE_DELAYED_GCODE ID=VERIFY_PRINT_D DURATION=0 
    {% endif %}    


[gcode_macro MOVE_SAVE_Z_POSITION]    
description: Calculations a save Z-Position for other macros like PAUSE, CANCEL, END
gcode:    

    {% set z_park = printer['gcode_macro _global_var'].pause_park.z|float %}
    {% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_printer %}
    {% set z_now = printer.gcode_move.position.z|float %}
    {% set stop = False %}
    
    #SET_GCODE_VARIABLE MACRO=_global_var VARIABLE=stop_action VALUE='False'
    SAVE_VARIABLE VARIABLE=stop_action VALUE={stop}
    
    M117 [Debug] Stop Action Inside: {printer.save_variables.variables.stop_action}   
    M117 [Debug] Z ist aktuell: {z_now}
    M117 [Debug] Pause Print - State : {state}
    G91
    {% if z_now >= z_lift_max %}                                          ; actual position is allready ad printer maximum
      M117 Z-Limit {z_now}/{z_lift_max} reached. 
      {% set stop = True %}
    {% elif z_now < z_park %}                                             ; actual position is under z-park postion 
      {% set move = z_park - z_now %}                                     ; calculate relative steps to reach z-park
      M117 [Debug] Move to Z-Park ({z_park} mm) 
      G1 Z+{move} F3000
    {% else %}                                                            ; actulal position is over z-park postion
      {% set lift = 5 %} 
      {% if z_now + lift > z_lift_max %}                                  ; if the lift would exceed printer maximum
        {% set lift = z_lift_max - z_now %}                               ; calculate difference between max and now
      {% endif %} 
      {% if lift <= 0 %}                                                  ; if the lift is negative or zero stop moving
        M117 [Error] Printer limit. No space left for raising nozzle
        {% set stop = True %}
      {% else %}                                                          ; else move relative steps to maximum
        M117 [Debug] Hebe Z um {lift}mm 
        G1 Z+{lift} F3000 
      {% endif %}
    {% endif %}
    #SET_GCODE_VARIABLE MACRO=_global_var VARIABLE=stop_action VALUE={'True' if stop else 'False'}
    SAVE_VARIABLE VARIABLE=stop_action VALUE={'True' if stop else 'False'}